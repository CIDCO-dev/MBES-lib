<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EM datagrams on *.kmall format: Total uncertainty</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="KMlogo.PNG"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">EM datagrams on *.kmall format
   &#160;<span id="projectnumber">Reg. nr. 410224 rev I</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('totalUncertainty.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Total uncertainty </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="totalHorAndVerUncertainty"></a>
Total horizontal and vertical uncertainty estimation</h1>
<p>The kmall-format used by the Kongsberg EM®-systems has two fields for every depth; Total Horizontal Uncertainty (THU) and Total Vertical Uncertainty (TVU). This memo outlines how THU and TVU are calculated. </p>
<p>We have considered five contributors to the uncertainty of the depth measurements from the EM®-systems: The EM® itself, the Motion Reference Unit (MRU), the compass (heading), the sound speed profile (SVP), and the positioning system (GPS). The initial assumption is that the uncertainty in the EM® is the dominating contributor to the total uncertainty, and this has been largely confirmed in this study, with some additional notes. </p>
<p>Tide and height uncertainties are not part of this memo. The reason for this is simply that the EM®-system has no information about these uncertainties as they depend on external sources. In a complete error budget these should be added to get the total uncertainty for the end product.</p>
<p>THU and TVU will not be able to say anything about errors in the installation parameters such as leverarms and installation angles, only about the estimated uncertainty of the depth measurement itself. Additional calibration is needed to remove installation errors.</p>
<h3>Sound Speed Profile</h3>
<p>The accuracy of the sound speed profile sensor is approximately ±0.025 m/s. Assume that the sound speed is 1500 m/s, and that the travel time in water is 1 s. Then the travelled distance is 1500m. Given the accuracy of the sensor, the real distance will range from 1499.075m to 1500.025m.</p>
<p>The sound wave will bend according to the sound speed difference at different depths, so there is a gradient between two speed measurements at different depths. Simulations have shown that even when applying a random error to each sound speed measurement, the uncertainty contribution from the gradient is very small (centimeters) even at high beam angles (80 degrees) and at maximum depth (12000 meters). </p>
<p>The conclusion is that the sound speed profile gives a contribution to the total uncertainty both in horizontal and vertical direction that is very much smaller than contribution from the other sensors. </p>
<p><em> This conclusion assumes that the sound speed profile is a true representation of the conditions in the whole of the water volume. Normally the svp is measured straight down from the ship at regular intervals. Should this svp not be representative for the whole water volume, the uncertainty will increase and can be very difficult to estimate. </em> </p>
<h3>Motion Reference Unit</h3>
<p>The uncertainty model for the MRU is defined like this (Δβ exaggerated for the sake of clarity).<br  />
 <img src="mru.jpg" alt="" width="700" class="inline"/><br  />
 <img src="eq1.jpg" alt="" width="700" class="inline"/> </p>
<p>Equation [5] gives the uncertainty in depth (vertical direction) and equation [6] the uncertainty in across (horizontal) direction. ∆β is assumed to be the uncertainty in the MRU sensor in roll direction as shown in figure. With an estimated MRU RMS of 0.008 degrees, we get the following table. </p><table class="doxtable">
<tr>
<th>Depths\Angles</th><th>10</th><th>20</th><th>30</th><th>40</th><th>50</th><th>60</th><th>70</th><th>80</th><th>Across</th><th>0.1% of depth </th></tr>
<tr>
<td>100</td><td>0.0</td><td>0.01</td><td>0.01</td><td>0.01</td><td>0.02</td><td>0.02</td><td>0.04</td><td>0.08</td><td>0.01</td><td>0.1 </td></tr>
<tr>
<td>1000</td><td>0.02</td><td>0.05</td><td>0.08</td><td>0.12</td><td>0.17</td><td>0.24</td><td>0.38</td><td>0.79</td><td>0.14</td><td>1 </td></tr>
<tr>
<td>3000</td><td>0.07</td><td>0.15</td><td>0.24</td><td>0.35</td><td>0.50</td><td>0.73</td><td>1.15</td><td>2.38</td><td>0.42</td><td>3 </td></tr>
<tr>
<td>5000</td><td>0.12</td><td>0.25</td><td>0.4</td><td>0.59</td><td>0.83</td><td>1.21</td><td>1.92</td><td>3.96</td><td>0.70</td><td>5 </td></tr>
<tr>
<td>7000</td><td>0.17</td><td>0.36</td><td>0.56</td><td>0.82</td><td>1.16</td><td>1.69</td><td>2.69</td><td>5.54</td><td>0.98</td><td>7 </td></tr>
<tr>
<td>10000</td><td>0.25</td><td>0.51</td><td>0.81</td><td>1.17</td><td>1.66</td><td>2.42</td><td>3.84</td><td>7.92</td><td>1.40</td><td>10 </td></tr>
<tr>
<td>12000</td><td>0.30</td><td>0.61</td><td>0.97</td><td>1.41</td><td>2.0</td><td>2.90</td><td>4.60</td><td>9.50</td><td>1.68</td><td>12 </td></tr>
</table>
<p>From the table we see that MRU error will contribute to the depth (vertical) uncertainty, but very little to the across (horizontal) uncertainty </p>
<p>The same model will apply for pitch. However, as the pitch movement normally is significantly smaller than the beam steering across, the contribution from pitch will normally be less than 20 degrees and from the tables above we see that such a small angle can be said to not contribute to the total uncertainty. </p>
<h3>Compass</h3>
<p>The uncertainty model for the compass is defined like this. </p>
<p><img src="compass.jpg" alt="" class="inline"/> </p>
<p><img src="eq2.jpg" alt="" width="500" class="inline"/> </p>
<p>For small angles α the fraction sin/cos in [10] can be regarded as linear with α and can be calculated to 0,0174532918, thus giving [11]: </p>
<p><img src="eq3.jpg" alt="" width="500" class="inline"/> </p>
<p>Example: with a compass RMS of 0.1 degree, the horizontal uncertainty D at 1000 meters range is: D = 1000 x 0,0174532 x 0,1 = 1,7 meters. For a fixed value (the compass actually installed) of α we see that D is directly proportional with the range. The value 0,017453218 is approximately the same as tan(1degree) which is almost the same as [1]. </p>
<h3>Positioning system (GPS)</h3>
<p>The uncertainty from the positioning system is found in the NMEA GST datagram. This datagram comes from the GPS sensor which is assumed to be the de facto standard for positioning systems today.<br  />
 The GST datagram looks like this (extract from Trimble website):<br  />
 $GPGST,172814.0,0.006,0.023,0.020,273.6,0.023,0.020,0.031*6A </p>
<table class="doxtable">
<tr>
<th>Field</th><th>Meaning </th></tr>
<tr>
<td>0</td><td>Message ID $GPGST </td></tr>
<tr>
<td>1</td><td>UTC of position fix </td></tr>
<tr>
<td>2</td><td>RMS value of the pseudorange residuals; includes carrier phase residuals during periods of RTK (float) and RTK (fixed) processing </td></tr>
<tr>
<td>3</td><td>Error ellipse semi-major axis 1 sigma error, in meters </td></tr>
<tr>
<td>4</td><td>Error ellipse semi-minor axis 1 sigma error, in meters </td></tr>
<tr>
<td>5</td><td>Error ellipse orientation, degrees from true north </td></tr>
<tr>
<td>6</td><td>Latitude 1 sigma error, in meters </td></tr>
<tr>
<td>7</td><td>Longitude 1 sigma error, in meters </td></tr>
<tr>
<td>8</td><td>Height 1 sigma error, in meters </td></tr>
<tr>
<td>9</td><td>The checksum data, always begins with * </td></tr>
</table>
<p>For the sake of clarity we use only the major axis of the error ellipse. We want to have only one number for the total horizontal uncertainty so this value will be used. We assume that 1 sigma and 1 RMS are similar values. </p>
<h3>EM®</h3>
<p>For each depth a q-factor is calculated, and this q-factor is described in the paper 16_YoannLadroit_ConstraintsAndLimitations.pdf. The q-factor can be used to calculate horizontal and vertical uncertainty for each depth as described in the documentation for the kmall-format. Additional information is found in <a class="el" href="totalUncertainty.html#emQualityFactor">EM quality factor</a>. </p>
<h3>Adding it all together</h3>
<p>The horizontal uncertainty estimation can then be written like this:<br  />
 THU=Compass + GPS(NMEA GST field 3) + EMq(horizontal) </p>
<p>The vertical uncertainty estimation is then written like this:<br  />
 TVU=EMq(vertical) + MRU </p>
<p>We see that all values are RMS-values so we add them together like this:<br  />
 <img src="eq4.jpg" alt="" width="500" class="inline"/><br  />
 Where D is the contribution from the compass, GST is the major axis in the GST-datagram, and EMq is the horizontal component from the EM. </p>
<p><img src="eq5.jpg" alt="" width="500" class="inline"/><br  />
 </p>
<p>MRU is here the contribution from the MRU in eq. [5]. </p>
<p>These equations require two parameters, the uncertainty for the compass and the uncertainty for the MRU. In SIS we find SIS→Tools→Parameter Setup, and there we find a chapter Error Model Parameters. There the uncertainties for MRU and compass can be set, and then SIS will use these parameters to calculate THU and TVU for each depth. </p>
<p>In the kmall-format the MRZ-datagram has two values for each depth, <em>detectionUncertaintyVer_m</em> and <em>detectionUncertaintyHor_m</em>. These two values will hold the TVU and THU values calculated in the equations [12] and [13]. </p>
<h3>Variance in the uncertainty estimations</h3>
<p>The KMall datagram has one Q-factor per sounding. <br  />
 To get high resolution and individual soundings, KM uses a small area on bottom for each detection. The more soundings, the smaller is the area used.<br  />
 With small area the number of samples used is low. This means that the Q-factor will vary relatively much from sounding to sounding.<br  />
 This is due to the speckle effect (some areas gives a nice coherent echoes, while others may give weak and noisy returns). </p>
<p>For soundings without accepted detection, the Q-factor is set to zero.<br  />
 In post processing the Q-factors can be median filtered for example by using a grid. <br  />
 This will reduce the Q-factor noise, and then it should be possible to observe incidence angle and bottom type dependencies.<br  />
 Examples and further illustrations of these effects can be seen in <a class="el" href="totalUncertainty.html#emQualityFactor">EM quality factor</a>.</p>
<h1><a class="anchor" id="emQualityFactor"></a>
EM quality factor</h1>
<p>This section explains why some detections have high uncertainty values, anhd why the variance between measurements is high.</p>
<h3>Ifremer quality factor</h3>
<p>The analysis in this section is based on one EM2040 ping.</p>
<h3>Ifremer Quality Factor spikes</h3>
<p>Red = QF for final detection (for one ping)<br  />
 <img src="f1.png" alt="" class="inline"/> </p>
<p><img src="f2.png" alt="" class="inline"/><br  />
 <img src="f3.png" alt="" class="inline"/><br  />
 <img src="f4.png" alt="" class="inline"/><br  />
 KM use linear regression (black line in the figure above) to find the split beam phase zero crossing. To achieve high resolution, we need a short phase ramp. The KM phase detection algorithm performs several successive phase detections by shortening the phase ramp by each step. The detection is shown as small circle on the black regression line. </p>
<p>The final detect range uncertainty in beam 31-33 varies from 0.18% to 0.78%. First detect range uncertainty varies from 0.13% to 0.17%. The uncertainty for last and final detection is used in the kmall datagram. </p>
<p>The expression for calculating the range uncertainty is developed by Ifremer: </p><pre>
// Estimated standard deviation as % of depth
    Tp = effective pulse length in samples
    Win = detection window  in samples
    r_zero = zero crossing in samples
    p_slope = linear regression slope [rad/sample]
    var_p = phase variance.
</pre><p>ns = win / Tp; <br  />
 stdev = 100.0* sqrt(var_p/(p_slope*p_slope*ns) + Tp*Tp/12.0)/r_zero; // Ifremer QF <br  />
 The expression has slope as a denominator. This means that small slope makes a large stdev. The goal of the p_slope part is to convert a variance in phase to a variance in range. </p>
<p>Uncertainty spikes are caused by low slope value or locally elevated phase variance. By investigating beams 31-33: </p><ul>
<li>
beam 31 has low phase variance/ok slope = low uncertainty </li>
<li>
beam 32 has high phase variance/flat slope = high uncertainty </li>
<li>
beam 33 has high phase variance/ok slope = slightly elevated uncertainty </li>
</ul>
<p>Reduced slope and elevated phase variance can be “connected” since a slope in the terrain will change the lineare regression slope value and incidence angle. </p>
<h3>Beam 43</h3>
<p><img src="f5.png" alt="" class="inline"/><br  />
 Beam 43 is also a beam with elevated QF. The phase variance in figure 3 is almost the same for the three cases, but the slope has increased by 3. At the last linear the regression slope of the linear fit has changed from 0.45 to 0.15 deg. As seen in fig.3, beam 43 has a higher uncertainty at final detection (0.49%) compared to the first detection (0.10%). </p>
<h3>First vs. last phase detection</h3>
<p>Red = QF for final detection<br  />
 Blue = QF for first detection<br  />
 <img src="f6.png" alt="" class="inline"/><br  />
 First detect QF as a function of beam angle has the expected bathtub shape, which corresponds better to the expected average depth error as a function of angle. </p>
<p><img src="f7.png" alt="" class="inline"/><br  />
 The first detect QF does not have the spikes since the regression phase slope does not vary much from one beam to another. </p>
<p><img src="f8.png" alt="" class="inline"/><br  />
 </p>
<h3>.ALL Quality Factor</h3>
<pre>
pb-&gt;phasevar = var_p / (p_slope * p_slope);  /* phasevar is actually range var
pb-&gt;variance = pb-&gt;rangescale * pb-&gt;rangescale * pb-&gt;phasevar;
int_var = iroundf(qualityscale * sqrt( beam_p-&gt;variance ) / beam_p-&gt;range);
</pre> <p>The old KM .all quality factor has the same spikes as seen for kmall. That is not a surprise since the expression for .all is the same as for .kmall except for the scaling. </p>
<p><img src="f9.png" alt="" class="inline"/><br  />
 </p>
<p>Some selected pings:<br  />
 <img src="f10.png" alt="" class="inline"/><br  />
 <img src="f11.png" alt="" class="inline"/><br  />
 <img src="f12.png" alt="" class="inline"/><br  />
 </p>
<h3>Conclusion</h3>
<p>The KMall datagram has one Q-factor per sounding. <br  />
 To get high resolution and individual soundings, KM uses a small area on bottom for each detection. The more soundings, the smaller is the area used.<br  />
 With small area the number of samples used is low. This means that the Q-factor will vary relatively much from sounding to sounding.<br  />
 This is due to the speckle effect (some areas gives a nice coherent echoes, while others may give weak and noisy returns). </p>
<p>For soundings without accepted detection, the Q-factor is set to zero.<br  />
 In post processing the Q-factors can be median filtered for example by using a grid. <br  />
 This will reduce the Q-factor noise, and then it should be possible to observe incidence angle and bottom type dependencies.<br  />
</p>
<h1><a class="anchor" id="qualityFactor"></a>
Quality factor calculation</h1>
<p>The <em>qualityFactor</em> can be decomposed into horizontal and vertical uncertainty for each depth. These uncertainties will then be the contribution from the EM-system to the total horizontal and vertical uncertainty estimations. The following variables are found in the #MRZ-datagram: <br  />
 <a class="el" href="structEMdgmMRZ__sounding__def.html#a5ce967135eaf1feb11f80d8bf9dbe763">EMdgmMRZ_sounding_def.twoWayTravelTime_sec</a> <br  />
 <a class="el" href="structEMdgmMRZ__pingInfo__def.html#a317647ab319945de0520c61959781813">EMdgmMRZ_pingInfo_def.soundSpeedAtTxDepth_mPerSec</a> <br  />
 <a class="el" href="structEMdgmMRZ__sounding__def.html#a13bfe7b69a73be6c98f1b0a36571c747">EMdgmMRZ_sounding_def.y_reRefPoint_m</a> <br  />
 <a class="el" href="structEMdgmMRZ__sounding__def.html#ac2994046e45eeacfaa853c4f92bf953f">EMdgmMRZ_sounding_def.z_reRefPoint_m</a> <br  />
 <a class="el" href="structEMdgmMRZ__sounding__def.html#a4077ce7551c20643bcc72233bb31c5bb">EMdgmMRZ_sounding_def.qualityFactor</a> </p>
<p>Then we can use these formulas to calculate horizontal and vertical uncertaintiy contributions for each depth:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Equation </th><th class="markdownTableHeadNone">Formula  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Eq. 1 </td><td class="markdownTableBodyNone"><img src="ems1.png" alt="" align="left" width="700" class="inline"/>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Eq. 2 </td><td class="markdownTableBodyNone"><img src="ems2.png" alt="" align="left" width="700" class="inline"/>  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Eq. 3 </td><td class="markdownTableBodyNone"><img src="ems3.png" alt="" align="left" width="700" class="inline"/>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Eq. 4 </td><td class="markdownTableBodyNone"><img src="ems4.png" alt="" align="left" width="700" class="inline"/>  </td></tr>
</table>
<p>Eq. 3 and 4 are now the vertical and horizontal uncertainty estimate from the EM for the depth. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
